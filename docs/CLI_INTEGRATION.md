# Taskmaster CLI Integration

This document describes the Taskmaster CLI integration implemented for the GitHub Actions template.

## Overview

The Taskmaster CLI integration provides:
- **Binary Management**: Download and pin specific versions of the Taskmaster CLI binary
- **Security**: Checksum validation to prevent tampering
- **Configuration**: Flexible parameter management for CLI execution
- **Output Processing**: Parsing and validation of CLI output formats
- **Error Handling**: Comprehensive error handling and logging

## Architecture

### Components

1. **TaskmasterCLIManager** (`src/cli-manager.ts`)
   - Handles binary download and validation
   - Manages CLI execution with timeout controls
   - Parses and validates CLI output
   - Applies complexity threshold filtering

2. **TaskmasterAction** (`src/main.ts`)
   - Orchestrates the entire workflow
   - Handles input parsing and validation
   - Manages file operations and output generation

### Key Features

#### Binary Download and Validation
- Downloads CLI binary from specified URL
- Validates binary integrity using SHA256 checksums
- Supports multiple platforms (Linux, macOS, Windows)
- Handles different architectures (AMD64, ARM64)

#### Configuration Management
- Complexity threshold filtering (default: 40)
- Max depth control (default: 3)
- PRD path glob pattern support
- Additional CLI arguments support

#### Output Processing
- Validates JSON structure and required fields
- Applies complexity-based task filtering
- Generates standardized task-graph.json format
- Includes comprehensive metadata

## Usage

### Basic Usage

```bash
# Set environment variables
export INPUT_COMPLEXITY_THRESHOLD=40
export INPUT_MAX_DEPTH=3
export INPUT_PRD_PATH_GLOB="docs/*.prd.md"
export INPUT_BREAKDOWN_MAX_DEPTH=2
export INPUT_TASKMASTER_ARGS="--verbose"

# Run the integration
node src/main.js
```

### GitHub Actions Integration

The integration is automatically used in the GitHub Action workflow:

```yaml
- name: Generate task graph
  id: generate
  shell: bash
  env:
    INPUT_COMPLEXITY_THRESHOLD: ${{ inputs.complexity-threshold }}
    INPUT_MAX_DEPTH: ${{ inputs.max-depth }}
    INPUT_PRD_PATH_GLOB: ${{ inputs.prd-path-glob }}
    INPUT_BREAKDOWN_MAX_DEPTH: ${{ inputs.breakdown-max-depth }}
    INPUT_TASKMASTER_ARGS: ${{ inputs.taskmaster-args }}
  run: |
    node src/main.js
```

## Configuration

### CLI Configuration

```typescript
interface CLIConfig {
  version: string;           // CLI version to use
  baseUrl: string;          // Base URL for binary downloads
  checksums: Record<string, string>; // Platform-specific checksums
  binaryName: string;       // Binary name
}
```

### Execution Options

```typescript
interface CLIOptions {
  complexityThreshold: number;  // Maximum task complexity
  maxDepth: number;            // Maximum hierarchy depth
  prdPathGlob: string;         // PRD file pattern
  breakdownMaxDepth: number;   // Breakdown depth limit
  additionalArgs: string[];    // Additional CLI arguments
}
```

## Output Format

The integration produces a standardized task-graph.json format:

```json
{
  "master": {
    "tasks": [
      {
        "id": 1,
        "title": "Task Title",
        "description": "Task description",
        "complexity": 5,
        "priority": "high",
        "dependencies": [],
        "status": "pending"
      }
    ],
    "metadata": {
      "created": "2023-01-01T00:00:00.000Z",
      "updated": "2023-01-01T00:00:00.000Z",
      "description": "Generated by Taskmaster CLI",
      "complexityThreshold": 40,
      "maxDepth": 3,
      "prdFiles": ["docs/sample.prd.md"],
      "tasksTotal": 10,
      "tasksFiltered": 7
    }
  }
}
```

## Error Handling

The integration includes comprehensive error handling for:
- Binary download failures
- Checksum validation errors
- CLI execution timeouts
- Invalid output formats
- File system errors

## Security

- **Checksum Validation**: All binaries are validated using SHA256 checksums
- **Timeout Controls**: CLI execution has a 2-minute timeout
- **Input Validation**: All inputs are validated before processing
- **Error Sanitization**: Error messages are sanitized to prevent information leakage

## Testing

The integration includes a comprehensive test suite:

```bash
npm test
```

Test coverage includes:
- Binary download and validation
- Output parsing and validation
- Error handling scenarios
- Edge cases and input validation

## Troubleshooting

### Common Issues

1. **Binary Download Failures**
   - Check network connectivity
   - Verify URL accessibility
   - Check platform/architecture support

2. **Checksum Validation Errors**
   - Ensure correct checksums in configuration
   - Check for corrupted downloads
   - Verify binary integrity

3. **CLI Execution Timeouts**
   - Increase timeout if processing large PRDs
   - Check system resources
   - Verify PRD file accessibility

### Debug Mode

Enable debug logging with additional arguments:

```bash
export INPUT_TASKMASTER_ARGS="--verbose --debug"
```

## Future Enhancements

Potential improvements for future versions:
- Parallel processing for multiple PRD files
- Caching of downloaded binaries
- Advanced retry mechanisms
- Custom timeout configurations
- Plugin system for output formatters